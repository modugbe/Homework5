# Preliminaries -----------------------------------------------------------
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, stringr, readxl, data.table, gdata, fixest, scales)


# Read data and set workspace for knitr -------------------------------
acs.insurance <- read.table('data/output/acs_insurance.txt', header = TRUE, fill = TRUE, sep = "\t")
acs.medicaid <- read.table('data/output/acs_medicaid.txt', header = TRUE, fill = TRUE, sep = "\t")
medicaid.expansion <- read.table('data/output/medicaid_expansion.txt', header = TRUE, fill = TRUE, sep = "\t")


#number 1
share_data <- acs.medicaid %>%
                mutate(share_direct_purchase = (ins_direct/adult_pop)/100) 

number1 <- ggplot(data = share_data, aes(x = year, y = share_direct_purchase)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", 
      y = "Share of Adult Population with Direct Purchase Health Insurance",
      title = "Trend of Share of Adult Population with Direct Purchase Health Insurance") +
  theme_minimal()

#number 3
share_data <- acs.medicaid %>%
                mutate(share_medicaid = (ins_medicaid/adult_pop)/100) 

number3 <- ggplot(data = share_data, aes(x = year, y = share_medicaid)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", 
      y = "Share of Adult Population with Medicaid",
      title = "Trend of Share of Adult Population with Medicaid") +
  theme_minimal()

#number 4

# Filter the data for states that expanded Medicaid in 2014 or did not expand
expansion_share_data <- acs.medicaid %>%
  filter(is.na(expand_year) | expand_year == 2014) %>%
  mutate(share_uninsured = (uninsured / adult_pop) / 100) %>%
  mutate(medicaid_expansion = ifelse(expand_year == 2014, "Expanded in 2014", "Did not expand in 2014")) %>%
  replace_na(list(medicaid_expansion = "Did not expand in 2014"))

# Plot the share of uninsured over time, separately by Medicaid expansion status
number4 <- ggplot(data = expansion_share_data, aes(x = year, y = share_uninsured, fill = medicaid_expansion)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Expanded in 2014" = "#5656c068", "Did not expand in 2014" = "#c27575")) +
  labs(x = "Year", y = "Share of Population Uninsured", title = "Share of Uninsured Over Time by Medicaid Expansion Status")


#number 5
number5_data <- acs.medicaid %>%
  filter(year %in% c(2012, 2015))

# Calculate the average percent of uninsured individuals for expansion and non-expansion states in each year
dd_table <- filtered_data %>%
  group_by(expand_ever, year) %>%
  summarise(average_uninsured = mean(uninsured / adult_pop) * 100)

# Present the results in a table
dd_table <- spread(dd_table, year, average_uninsured) %>%
  mutate(expand_ever = ifelse(expand_ever, "Expansion States", "Non-Expansion States")) %>%
  column_to_rownames(var = "expand_ever") %>%
  as.data.frame()

# Add row and column names
rownames(dd_table) <- c("Non-Expansion States", "Expansion States")
colnames(dd_table) <- c("2012", "2015")

# Display the table
dd_table

#number 6
library(tidyverse)
library(modelsummary)

acs.medicaid <- acs.medicaid %>% 
    mutate(expand_ever_dummy = ifelse(expand_ever=="TRUE", 1, 0))

reg.dat <- acs.medicaid %>% filter(expand_year==2014 | is.na(expand_year), !is.na(expand_ever)) %>%
  mutate(perc_unins=uninsured/adult_pop,
         post = (year>=2014), 
         treat=post*expand_ever)

dd.ins.reg <- lm(perc_unins ~ post + expand_ever_dummy + post*expand_ever_dummy, data=reg.dat)

number6 <- modelsummary(list("DD (2014)"=dd.ins.reg),
             shape=term + statistic ~ model, 
             gof_map=NA,
             coef_omit='Intercept',
         )


#number 7
library(fixest)
m.twfe <- feols(perc_unins ~ post + expand_ever_dummy + State + year | State, data = reg.dat)

number7 <- msummary(list("DD"=dd.ins.reg, "TWFE"=m.twfe),
         shape=term + statistic ~ model, 
         gof_map=NA,
         coef_omit='Intercept',
         )


#number 8
reg.dat_all <- acs.medicaid %>% 
  mutate(perc_unins = uninsured / adult_pop,
         post = (year >= 2014), 
         treat = post * expand_ever)

# Run the regression with fixed effects
dd.ins.reg_all <- feols(perc_unins ~ post + expand_ever_dummy + State + year | State, data = reg.dat_all)

number8 <- msummary(list("TWFE7"=m.twfe, "TWFE8"=dd.ins.reg_all),
         shape=term + statistic ~ model, 
         gof_map=NA,
         coef_omit='Intercept',
         )


#number 9
library(tidyverse)
library(modelsummary)
library(fixest)
reg.dat <- acs.medicaid %>% 
  filter(expand_year==2014 | is.na(expand_year), !is.na(expand_ever)) %>%
  mutate(perc_unins=uninsured/adult_pop,
         post = (year>=2014), 
         treat=post*expand_ever)

mod.twfe <- feols(perc_unins~i(year, expand_ever, ref=2013) ,
                  cluster=~State,
                  data=reg.dat)

number9 <- iplot(mod.twfe, 
      xlab = 'Time to treatment',
      main = 'Event study')


#number 10
reg.dat <- acs.medicaid %>% 
  filter(!is.na(expand_ever)) %>%
  mutate(perc_unins = uninsured / adult_pop,
         post = year >= 2014,
         expand_year = ifelse(is.na(expand_year), year, expand_year),
         event_time = expand_year - 2014)  # Align all states to event time (2014)

# Run the fixed effects regression with treatment effect
mod.twfe <- feols(perc_unins ~ i(event_time, expand_ever), 
                  cluster = ~State,
                  data = reg.dat)

# Create the event study plot
number10 <- iplot(mod.twfe, 
      xlab = 'Time to treatment',
      main = 'Event study')

rm(list=c("acs.insurance", "acs.medicaid",
           "medicaid.expansion"))
save.image("submission2/Hwk5_workspace.Rdata")